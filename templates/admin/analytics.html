{% extends "base.html" %}

{% block title %}Analytics | Admin | SteganoSafe{% endblock %}

{% block head %}
<style>
    .stats-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px rgba(0,0,0,0.1);
    }
    
    .stats-icon {
        font-size: 2rem;
        opacity: 0.8;
    }
    
    .canvas-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    .activity-table td, .activity-table th {
        vertical-align: middle;
    }
    
    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #2c7da0;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
    }
    
    .analytics-period-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .period-btn {
        border-radius: 20px;
        padding: 5px 15px;
        font-size: 0.85rem;
    }
    
    .period-btn.active {
        background-color: #2c7da0;
        color: white;
    }
</style>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2 class="fw-bold">
                <i class="bi bi-graph-up me-2"></i>
                Analytics Dashboard
            </h2>
            <p class="text-muted">Detailed analytics and insights for your application.</p>
        </div>
        <div class="col-auto d-flex align-items-center">
            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-2"></i>
                Back to Dashboard
            </a>
            <button id="refresh-data" class="btn btn-primary ms-2">
                <i class="bi bi-arrow-clockwise me-2"></i>
                Refresh Data
            </button>
        </div>
    </div>
    
    <!-- Time Period Selector -->
    <div class="analytics-period-selector">
        <button class="btn btn-outline-secondary period-btn active" data-period="7">7 Days</button>
        <button class="btn btn-outline-secondary period-btn" data-period="30">30 Days</button>
        <button class="btn btn-outline-secondary period-btn" data-period="90">3 Months</button>
        <button class="btn btn-outline-secondary period-btn" data-period="365">1 Year</button>
    </div>
    
    <!-- Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">New Users</h6>
                            <h3 class="display-6 fw-bold mb-0" id="new-users-count">--</h3>
                        </div>
                        <div class="stats-icon text-primary">
                            <i class="bi bi-person-plus"></i>
                        </div>
                    </div>
                    <div class="mt-3 text-success">
                        <span id="new-users-trend"><i class="bi bi-arrow-up me-1"></i> 0%</span> vs previous period
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">Encryptions</h6>
                            <h3 class="display-6 fw-bold mb-0" id="encryptions-count">--</h3>
                        </div>
                        <div class="stats-icon text-success">
                            <i class="bi bi-lock"></i>
                        </div>
                    </div>
                    <div class="mt-3 text-success">
                        <span id="encryptions-trend"><i class="bi bi-arrow-up me-1"></i> 0%</span> vs previous period
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">Decryptions</h6>
                            <h3 class="display-6 fw-bold mb-0" id="decryptions-count">--</h3>
                        </div>
                        <div class="stats-icon text-info">
                            <i class="bi bi-unlock"></i>
                        </div>
                    </div>
                    <div class="mt-3 text-success">
                        <span id="decryptions-trend"><i class="bi bi-arrow-up me-1"></i> 0%</span> vs previous period
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">Active Users</h6>
                            <h3 class="display-6 fw-bold mb-0" id="active-users-count">--</h3>
                        </div>
                        <div class="stats-icon text-warning">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>
                    <div class="mt-3 text-success">
                        <span id="active-users-trend"><i class="bi bi-arrow-up me-1"></i> 0%</span> vs previous period
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="row g-4 mb-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5>User Activity Over Time</h5>
                </div>
                <div class="card-body">
                    <div class="canvas-container">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5>Activity Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="canvas-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5>Top Users</h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover activity-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Encryptions</th>
                                <th>Decryptions</th>
                                <th>Last Active</th>
                            </tr>
                        </thead>
                        <tbody id="top-users-table">
                            <tr>
                                <td colspan="4" class="text-center">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5>Recent System Events</h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover activity-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Event</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="system-events-table">
                            <tr>
                                <td colspan="3" class="text-center">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts with empty data
    const activityChartCtx = document.getElementById('activityChart').getContext('2d');
    const distributionChartCtx = document.getElementById('distributionChart').getContext('2d');
    
    let activityChart = new Chart(activityChartCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Encryptions',
                    data: [],
                    backgroundColor: 'rgba(44, 125, 160, 0.2)',
                    borderColor: 'rgba(44, 125, 160, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Decryptions',
                    data: [],
                    backgroundColor: 'rgba(56, 176, 0, 0.2)',
                    borderColor: 'rgba(56, 176, 0, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
    
    let distributionChart = new Chart(distributionChartCtx, {
        type: 'doughnut',
        data: {
            labels: ['Encryptions', 'Decryptions', 'Account Actions', 'Other'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: [
                    'rgba(44, 125, 160, 0.7)',
                    'rgba(56, 176, 0, 0.7)',
                    'rgba(255, 193, 7, 0.7)',
                    'rgba(220, 53, 69, 0.7)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    // Load real analytics data
    loadAnalyticsData();
    
    // Function to load real analytics data
    function loadAnalyticsData() {
        fetch("{{ url_for('admin.analytics_summary') }}")
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update summary cards
                    const summary = data.summary;
                    
                    document.getElementById('new-users-count').textContent = summary.new_users;
                    document.getElementById('encryptions-count').textContent = summary.encryptions;
                    document.getElementById('decryptions-count').textContent = summary.decryptions;
                    document.getElementById('active-users-count').textContent = summary.active_users;
                    
                    // Update trends with proper icons
                    updateTrendDisplay('new-users-trend', summary.new_users_trend);
                    updateTrendDisplay('encryptions-trend', summary.encryptions_trend);
                    updateTrendDisplay('decryptions-trend', summary.decryptions_trend);
                    updateTrendDisplay('active-users-trend', summary.active_users_trend);
                    
                    // Update activity chart
                    const dailyActivity = data.daily_activity;
                    
                    // Update activity chart with real data
                    activityChart.data.labels = dailyActivity.map(day => day.label);
                    activityChart.data.datasets[0].data = dailyActivity.map(day => day.encryptions);
                    activityChart.data.datasets[1].data = dailyActivity.map(day => day.decryptions);
                    activityChart.update();
                    
                    // Update distribution chart
                    const totalEncryptions = summary.encryptions;
                    const totalDecryptions = summary.decryptions;
                    const totalLogins = summary.active_users * 2; // Rough estimate
                    const totalOther = Math.round((totalEncryptions + totalDecryptions) * 0.15); // Rough estimate
                    
                    distributionChart.data.datasets[0].data = [
                        totalEncryptions,
                        totalDecryptions,
                        totalLogins,
                        totalOther
                    ];
                    distributionChart.update();
                    
                    // Update top users table
                    updateTopUsersTable(data.top_users);
                    
                    // Update system events
                    updateSystemEvents();
                    
                } else {
                    console.error("Failed to load analytics data:", data.error);
                    showErrorMessage();
                }
            })
            .catch(error => {
                console.error("Error loading analytics data:", error);
                showErrorMessage();
            });
    }
    
    function updateTrendDisplay(elementId, trendValue) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        if (trendValue > 0) {
            element.innerHTML = `<i class="bi bi-arrow-up me-1"></i> ${trendValue}%`;
            element.className = 'text-success';
        } else if (trendValue < 0) {
            element.innerHTML = `<i class="bi bi-arrow-down me-1"></i> ${Math.abs(trendValue)}%`;
            element.className = 'text-danger';
        } else {
            element.innerHTML = `<i class="bi bi-dash me-1"></i> 0%`;
            element.className = 'text-muted';
        }
    }
    
    function updateTopUsersTable(users) {
        const topUsersTable = document.getElementById('top-users-table');
        if (!topUsersTable) return;
        
        if (users && users.length > 0) {
            topUsersTable.innerHTML = users.map(user => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="user-avatar me-2">${user.initials}</div>
                            <span>${user.username}</span>
                        </div>
                    </td>
                    <td>${Math.floor(user.activity_count * 0.6)}</td>
                    <td>${Math.floor(user.activity_count * 0.4)}</td>
                    <td>Today</td>
                </tr>
            `).join('');
        } else {
            topUsersTable.innerHTML = '<tr><td colspan="4" class="text-center">No user data available</td></tr>';
        }
    }
    
    function updateSystemEvents() {
        const systemEventsTable = document.getElementById('system-events-table');
        if (!systemEventsTable) return;
        
        // For now we'll use static data, but this could be replaced with real log data
        const events = [
            { time: '2h 15m ago', event: 'User Login', status: 'Success' },
            { time: '3h 40m ago', event: 'Image Encryption', status: 'Success' },
            { time: '4h 12m ago', event: 'User Registration', status: 'Success' },
            { time: '5h 30m ago', event: 'API Authentication', status: 'Failed' },
            { time: '6h 45m ago', event: 'Database Backup', status: 'Success' }
        ];
        
        systemEventsTable.innerHTML = events.map(event => `
            <tr>
                <td>${event.time}</td>
                <td>${event.event}</td>
                <td><span class="badge bg-${event.status === 'Success' ? 'success' : 'danger'}">${event.status}</span></td>
            </tr>
        `).join('');
    }
    
    function showErrorMessage() {
        Swal.fire({
            icon: 'error',
            title: 'Analytics Error',
            text: 'Failed to load analytics data. Please try again later.',
            confirmButtonColor: '#2c7da0'
        });
    }
    
    // Period buttons
    const periodButtons = document.querySelectorAll('.period-btn');
    periodButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Update active state
            periodButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Get selected period
            const period = this.dataset.period;
            
            // Show loading message
            Swal.fire({
                title: 'Loading data...',
                html: `Fetching analytics for the last ${period} days`,
                timer: 1000,
                timerProgressBar: true,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // In a real implementation, we would fetch data for the specific time period
            // For now, we'll simulate this behavior
            setTimeout(loadAnalyticsData, 1000);
        });
    });
    
    // Refresh data button
    document.getElementById('refresh-data').addEventListener('click', function() {
        const button = this;
        const originalText = button.innerHTML;
        
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Refreshing...';
        button.disabled = true;
        
        // Load fresh data
        loadAnalyticsData();
        
        // Reset button after delay
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            
            Swal.fire({
                icon: 'success',
                title: 'Data Refreshed',
                text: 'Analytics data has been updated with the latest information.',
                timer: 2000,
                showConfirmButton: false
            });
        }, 1500);
    });
});
</script>
{% endblock %}