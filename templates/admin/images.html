{% extends "admin/base.html" %}

{% block title %}Image Management | Admin Dashboard{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_images.css') }}">
{% endblock %}

{% block admin_content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mt-4">Image Management</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('admin_bp.index') }}">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Images</li>
            </ol>
        </nav>
    </div>

    <div class="row">
        <div class="col-xl-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-image me-1"></i>
                        Image Library
                    </div>
                    <div class="d-flex">
                        <form id="image-search-form" action="{{ url_for('admin_bp.images') }}" method="get" class="me-2">
                            <div class="input-group input-group-sm">
                                <input type="text" id="image-search" name="search" class="form-control" placeholder="Search images..." value="{{ search }}">
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </form>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="imageActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                Actions
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="imageActionsDropdown">
                                <li><a class="dropdown-item" href="{{ url_for('admin_bp.fix_images') }}">Fix Missing Images</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_bp.diagnose_images') }}">Diagnose Image Issues</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#bulkDeleteModal">Bulk Delete</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="all" onclick="filterImages('all')">All Images</button>
                            <button type="button" class="btn btn-outline-primary filter-btn" data-filter="lsb" onclick="filterImages('lsb')">LSB</button>
                            <button type="button" class="btn btn-outline-primary filter-btn" data-filter="dct" onclick="filterImages('dct')">DCT</button>
                            <button type="button" class="btn btn-outline-primary filter-btn" data-filter="pvd" onclick="filterImages('pvd')">PVD</button>
                        </div>
                    </div>

                    {% if images %}
                    <div class="table-container">
                        <table class="table table-hover table-striped admin-images-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Preview</th>
                                    <th>Filename</th>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for image in images %}
                                <tr class="image-row" data-category="{{ image.encryption_type.lower() if image.encryption_type else 'unknown' }}">
                                    <td>{{ image.id }}</td>
                                    <td class="image-cell">
                                        {% if image.has_image_data %}
                                        <img data-src="{{ image.preview_url }}" alt="Preview" class="lazy-load-image" data-original-src="{{ image.preview_url }}" width="80" height="80">
                                        {% else %}
                                        <div class="image-placeholder">
                                            <i class="fas fa-question"></i>
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td class="filename-cell" title="{{ image.original_filename }}">
                                        {{ image.original_filename }}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('admin_bp.user_detail', user_id=image.user_id) }}">
                                            {{ image.username }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if image.encryption_type == 'LSB' else 'success' if image.encryption_type == 'DCT' else 'warning' if image.encryption_type == 'PVD' else 'secondary' }}">
                                            {{ image.encryption_type }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if image.timestamp %}
                                        {{ image.timestamp.strftime('%Y-%m-%d %H:%M') }}
                                        {% endif %}
                                    </td>
                                    <td class="actions-cell">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-primary view-image-btn" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#imageViewModal" 
                                                    data-image-id="{{ image.id }}"
                                                    data-image-url="{{ image.preview_url }}"
                                                    data-image-name="{{ image.original_filename }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger delete-image-btn"
                                                   data-bs-toggle="modal" 
                                                   data-bs-target="#deleteConfirmModal"
                                                   data-image-id="{{ image.id }}"
                                                   data-image-name="{{ image.original_filename }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {# Pagination controls #}
                    <div class="mt-4">
                        <nav aria-label="Page navigation">
                            <ul class="pagination">
                                {% if pagination.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin_bp.images', page=pagination.prev_num, search=search, sort=sort, order=order) }}">Previous</a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">Previous</a>
                                </li>
                                {% endif %}
                                
                                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                    {% if page_num %}
                                        {% if page_num == pagination.page %}
                                        <li class="page-item active">
                                            <a class="page-link" href="#">{{ page_num }}</a>
                                        </li>
                                        {% else %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('admin_bp.images', page=page_num, search=search, sort=sort, order=order) }}">{{ page_num }}</a>
                                        </li>
                                        {% endif %}
                                    {% else %}
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#">...</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if pagination.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin_bp.images', page=pagination.next_num, search=search, sort=sort, order=order) }}">Next</a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">Next</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        <div class="text-center text-muted mt-2">
                            Showing {{ pagination.items|length }} of {{ pagination.total }} images
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info">No images found in the database.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image View Modal -->
<div class="modal fade" id="imageViewModal" tabindex="-1" aria-labelledby="imageViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageViewModalLabel">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="modalImageContainer" class="mb-3">
                    <img id="modalImage" src="" alt="Full size preview" class="img-fluid">
                </div>
                <div class="image-info">
                    <h6 id="modalImageName"></h6>
                    <div id="modalImageDetails" class="text-muted"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the image <strong id="deleteImageName"></strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteImageForm" method="POST" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Bulk Delete Images</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    This will delete multiple images based on your criteria.
                </div>
                
                <form id="bulkDeleteForm" method="POST" action="{{ url_for('admin_bp.bulk_delete_images') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label for="deleteType" class="form-label">Delete by type:</label>
                        <select class="form-select" id="deleteType" name="delete_type">
                            <option value="">Choose a deletion criteria</option>
                            <option value="all">All Images</option>
                            <option value="user">By User</option>
                            <option value="encryption_type">By Encryption Type</option>
                            <option value="older_than">Older Than Date</option>
                        </select>
                    </div>
                    
                    <div id="userSelectDiv" class="mb-3 d-none">
                        <label for="userSelect" class="form-label">Select User:</label>
                        <select class="form-select" id="userSelect" name="user_id">
                            <option value="">Select a user</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    
                    <div id="encryptionTypeDiv" class="mb-3 d-none">
                        <label for="encryptionType" class="form-label">Encryption Type:</label>
                        <select class="form-select" id="encryptionType" name="encryption_type">
                            <option value="LSB">LSB</option>
                            <option value="DCT">DCT</option>
                            <option value="PVD">PVD</option>
                            <option value="DWT">DWT</option>
                        </select>
                    </div>
                    
                    <div id="olderThanDiv" class="mb-3 d-none">
                        <label for="olderThanDate" class="form-label">Older Than:</label>
                        <input type="date" class="form-control" id="olderThanDate" name="older_than_date">
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirmBulkDelete" name="confirm_delete" required>
                        <label class="form-check-label" for="confirmBulkDelete">
                            I understand this will permanently delete the selected images
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="bulkDeleteForm" class="btn btn-danger">Delete Images</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/admin_images.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Loading images for admin panel");
    
    // Initialize enhanced image views
    document.querySelectorAll('.view-image-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const imageUrl = this.getAttribute('data-image-url');
            const imageName = this.getAttribute('data-image-name');
            const imageId = this.getAttribute('data-image-id');
            
            // Set modal content
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('modalImageName').textContent = imageName;
            document.getElementById('modalImageDetails').textContent = `Image ID: ${imageId}`;
            
            // Fetch additional image details
            fetch(`/admin/debug/image_preview/${imageId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.is_valid_image) {
                        document.getElementById('modalImageDetails').innerHTML = 
                            `Format: ${data.image_format}<br>` +
                            `Size: ${data.image_size[0]} x ${data.image_size[1]}<br>` +
                            `File size: ${Math.round(data.data_length / 1024)} KB`;
                    }
                })
                .catch(error => console.error('Error fetching image details:', error));
        });
    });
    
    // Handle delete confirmation modal
    document.querySelectorAll('.delete-image-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const imageId = this.getAttribute('data-image-id');
            const imageName = this.getAttribute('data-image-name');
            
            document.getElementById('deleteImageName').textContent = imageName;
            document.getElementById('deleteImageForm').action = `/admin/images/${imageId}/delete`;
        });
    });
    
    // Handle bulk delete form visibility
    document.getElementById('deleteType').addEventListener('change', function() {
        // Hide all conditional divs
        document.getElementById('userSelectDiv').classList.add('d-none');
        document.getElementById('encryptionTypeDiv').classList.add('d-none');
        document.getElementById('olderThanDiv').classList.add('d-none');
        
        // Show relevant div based on selection
        const deleteType = this.value;
        if (deleteType === 'user') {
            document.getElementById('userSelectDiv').classList.remove('d-none');
            loadUsers();
        } else if (deleteType === 'encryption_type') {
            document.getElementById('encryptionTypeDiv').classList.remove('d-none');
        } else if (deleteType === 'older_than') {
            document.getElementById('olderThanDiv').classList.remove('d-none');
        }
    });
    
    // Function to load users for dropdown
    function loadUsers() {
        const userSelect = document.getElementById('userSelect');
        
        // Only load if not already loaded
        if (userSelect.options.length <= 1) {
            fetch('/admin/api/users')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        data.users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.username} (${user.email})`;
                            userSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error loading users:', error));
        }
    }
    
    // Add lazy loading for images
    initLazyLoading();
    
    // Handle sorting toggles
    document.querySelectorAll('th[data-sort]').forEach(header => {
        header.addEventListener('click', function() {
            const sort = this.getAttribute('data-sort');
            const currentOrder = '{{ order }}';
            
            // Toggle order if already sorting by this column
            let newOrder = 'asc';
            if (sort === '{{ sort }}') {
                newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
            }
            
            // Redirect with new sort parameters
            window.location = `{{ url_for('admin_bp.images') }}?sort=${sort}&order=${newOrder}&search={{ search }}&page=1`;
        });
    });
});
</script>
{% endblock %}