{% extends "admin/base.html" %}

{% block title %}User Management - SteganoSafe Admin{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_bp.index') }}">Dashboard</a></li>
<li class="breadcrumb-item active" aria-current="page">User Management</li>
{% endblock %}

{% block admin_content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">User Management</h1>
        <p class="text-muted">View and manage all system users</p>
    </div>
    <div class="page-actions">
        <button type="button" class="admin-btn admin-btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="bi bi-person-plus me-2"></i> Add New User
        </button>
        <div class="dropdown d-inline-block ms-2">
            <button class="admin-btn admin-btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-download me-1"></i> Export
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" id="exportCsvBtn"><i class="bi bi-filetype-csv me-2"></i>CSV</a></li>
                <li><a class="dropdown-item" href="#" id="exportExcelBtn"><i class="bi bi-file-earmark-excel me-2"></i>Excel</a></li>
                <li><a class="dropdown-item" href="#" id="exportPdfBtn"><i class="bi bi-file-earmark-pdf me-2"></i>PDF</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- User Stats Overview -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="admin-stats-widget" style="--widget-color: var(--admin-primary); --widget-color-rgb: 67, 97, 238;">
            <div class="stats-widget-icon">
                <i class="bi bi-people-fill"></i>
            </div>
            <div class="stats-widget-content">
                <h3 class="stats-widget-value">{{ users|length }}</h3>
                <p class="stats-widget-label">Total Users</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="admin-stats-widget" style="--widget-color: var(--admin-success); --widget-color-rgb: 22, 199, 154;">
            <div class="stats-widget-icon">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stats-widget-content">
                <h3 class="stats-widget-value">{{ users|selectattr('is_verified', 'equalto', True)|list|length }}</h3>
                <p class="stats-widget-label">Verified Users</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="admin-stats-widget" style="--widget-color: var(--admin-warning); --widget-color-rgb: 248, 150, 30;">
            <div class="stats-widget-icon">
                <i class="bi bi-shield-check"></i>
            </div>
            <div class="stats-widget-content">
                <h3 class="stats-widget-value">{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</h3>
                <p class="stats-widget-label">Administrators</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="admin-stats-widget" style="--widget-color: var(--admin-info); --widget-color-rgb: 76, 201, 240;">
            <div class="stats-widget-icon">
                <i class="bi bi-person-plus"></i>
            </div>
            <div class="stats-widget-content">
                <h3 class="stats-widget-value">{{ recent_users|default(5) }}</h3>
                <p class="stats-widget-label">New This Week</p>
            </div>
        </div>
    </div>
</div>

<div class="admin-card mb-4">
    <div class="card-body">
        <div class="user-filters mb-3">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-end-0">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control border-start-0" id="userSearch" placeholder="Search by name, email or role...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="roleFilter">
                        <option value="">All Roles</option>
                        <option value="admin">Admin</option>
                        <option value="mod">Moderator</option>
                        <option value="user">User</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="verified">Verified</option>
                        <option value="unverified">Unverified</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-end-0">
                            <i class="bi bi-calendar3"></i>
                        </span>
                        <input type="text" class="form-control border-start-0" id="dateRangeFilter" placeholder="Date range">
                    </div>
                </div>
                <div class="col-md-1">
                    <button class="admin-btn admin-btn-outline-secondary w-100" id="resetFilters" title="Reset filters">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="user-selection-toolbar mb-3 d-none">
            <div class="d-flex align-items-center bg-light p-2 rounded">
                <div class="me-3">
                    <span class="selected-count fw-bold">0</span> users selected
                </div>
                <button class="admin-btn admin-btn-sm admin-btn-outline-primary me-2">
                    <i class="bi bi-check-circle me-1"></i> Verify Selected
                </button>
                <button class="admin-btn admin-btn-sm admin-btn-outline-warning me-2">
                    <i class="bi bi-lock me-1"></i> Lock Selected
                </button>
                <button class="admin-btn admin-btn-sm admin-btn-outline-danger">
                    <i class="bi bi-trash me-1"></i> Delete Selected
                </button>
                <button class="admin-btn admin-btn-sm admin-btn-outline-secondary ms-auto">
                    <i class="bi bi-x me-1"></i> Cancel
                </button>
            </div>
        </div>
        
        <div class="user-data-table">
            <table class="table table-hover datatable" id="usersTable">
                <thead>
                    <tr>
                        <th width="4%">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllUsers">
                                <label class="form-check-label" for="selectAllUsers"></label>
                            </div>
                        </th>
                        <th>User</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr data-user-id="{{ user.id }}" class="fade-in delay-{{ loop.index0 % 20 }}">
                        <td>
                            <div class="form-check">
                                <input class="form-check-input user-select-checkbox" type="checkbox" id="userSelect{{ user.id }}">
                                <label class="form-check-label" for="userSelect{{ user.id }}"></label>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar avatar-{{ user.role }}" title="{{ user.role|capitalize }}">
                                    {{ user.username[:1].upper() }}
                                </div>
                                <div class="ms-3">
                                    <h6 class="mb-0">
                                        <a href="{{ url_for('admin_bp.user_detail', user_id=user.id) }}" class="user-name-link">
                                            {{ user.username }}
                                        </a>
                                    </h6>
                                    <small class="text-muted">ID: {{ user.id }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ user.email }}</td>
                        <td>
                            <span class="badge bg-{{ 'warning' if user.role == 'admin' else 'success' if user.role == 'mod' else 'info' }}">
                                {{ user.role|capitalize }}
                            </span>
                        </td>
                        <td>
                            <span class="status-indicator-dot {{ 'success' if user.is_verified else 'danger' }}"></span>
                            <span>{{ 'Verified' if user.is_verified else 'Unverified' }}</span>
                        </td>
                        <td data-order="{{ user.created_at.strftime('%Y%m%d%H%M%S') }}">
                            {{ user.created_at.strftime('%b %d, %Y') }}
                        </td>
                        <td>
                            <div class="actions-dropdown">
                                <button class="action-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('admin_bp.user_detail', user_id=user.id) }}">
                                            <i class="bi bi-eye me-2"></i> View Profile
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item edit-user-btn" href="#" data-user-id="{{ user.id }}">
                                            <i class="bi bi-pencil me-2"></i> Edit
                                        </a>
                                    </li>
                                    {% if not user.is_verified %}
                                    <li>
                                        <a class="dropdown-item verify-user-btn" href="{{ url_for('admin_bp.verify_user', user_id=user.id) }}">
                                            <i class="bi bi-check-circle me-2"></i> Verify
                                        </a>
                                    </li>
                                    {% endif %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger delete-user-btn" href="#" 
                                           data-bs-toggle="modal" data-bs-target="#deleteUserModal" 
                                           data-user-id="{{ user.id }}" data-username="{{ user.username }}">
                                            <i class="bi bi-trash me-2"></i> Delete
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="text-muted">Showing <span id="showing-entries">1-{{ users|length }}</span> of <span class="total-entries">{{ users|length }}</span> entries</span>
            </div>
            <nav aria-label="User pagination">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1"><i class="bi bi-chevron-left"></i></a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#"><i class="bi bi-chevron-right"></i></a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- User Statistics -->
<div class="row g-4">
    <div class="col-lg-8">
        <div class="admin-card">
            <div class="card-header">
                <h5>User Registrations Trend</h5>
                <div class="card-header-actions">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active" data-period="weekly">Weekly</button>
                        <button class="btn btn-outline-secondary" data-period="monthly">Monthly</button>
                        <button class="btn btn-outline-secondary" data-period="yearly">Yearly</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="userRegistrationChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="admin-card">
            <div class="card-header">
                <h5>User Distribution</h5>
            </div>
            <div class="card-body">
                <div id="userRolesChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addUserForm" action="{{ url_for('admin_bp.add_user') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="newUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="newUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="newEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="newEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="newPassword" name="password" required>
                            <button class="btn btn-outline-secondary" type="button" id="passwordToggle">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength mt-2">
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="password-feedback text-muted">Password strength: Too weak</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="newRole" class="form-label">Role</label>
                        <select class="form-select" id="newRole" name="role">
                            <option value="user">User</option>
                            <option value="mod">Moderator</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isVerified" name="is_verified">
                        <label class="form-check-label" for="isVerified">Verified Account</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="admin-btn admin-btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Delete User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="display-1 text-danger mb-3">
                    <i class="bi bi-exclamation-circle"></i>
                </div>
                <h5>Are you sure you want to delete this user?</h5>
                <p class="user-delete-name mb-0"></p>
                <p class="text-muted small">This action cannot be undone. All associated data will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteUserForm" action="" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="admin-btn admin-btn-danger">Delete Permanently</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editUserForm" action="" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" name="username">
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" name="email">
                    </div>
                    <div class="mb-3">
                        <label for="editRole" class="form-label">Role</label>
                        <select class="form-select" id="editRole" name="role">
                            <option value="user">User</option>
                            <option value="mod">Moderator</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editIsVerified" name="is_verified">
                        <label class="form-check-label" for="editIsVerified">Verified Account</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="admin-btn admin-btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block admin_scripts %}
<!-- Add the loading overlay element first -->
<div id="loadingOverlay" class="loading-overlay" style="display:none">
    <div class="admin-spinner"></div>
</div>

<script src="https://cdn.datatables.net/buttons/2.3.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.5/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.5/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTable
    const table = $('#usersTable').DataTable({
        dom: 'rtip',
        pageLength: 10,
        responsive: true,
        ordering: true,
        info: false,
        language: {
            search: "",
            searchPlaceholder: "Search users...",
            zeroRecords: "No users found",
            info: "Showing _START_ to _END_ of _TOTAL_ users",
            infoEmpty: "Showing 0 to 0 of 0 users",
            infoFiltered: "(filtered from _MAX_ total users)"
        },
        columnDefs: [
            { orderable: false, targets: [0, 6] }
        ],
        order: [[5, 'desc']]
    });
    $('#userSearch').on('keyup', function() {
        table.search(this.value).draw();
        updateEntriesInfo();
    });
    
    // Role filter
    $('#roleFilter').on('change', function() {
        const value = $(this).val();
        table.column(3).search(value).draw();
        updateEntriesInfo();
    });
    
    // Status filter
    $('#statusFilter').on('change', function() {
        const value = $(this).val();
        table.column(4).search(value).draw();
        updateEntriesInfo();
    });
    
    // Date range picker
    $('#dateRangeFilter').daterangepicker({
        opens: 'left',
        autoUpdateInput: false,
        locale: {
            cancelLabel: 'Clear'
        }
    });
    
    $('#dateRangeFilter').on('apply.daterangepicker', function(ev, picker) {
        $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
        
        // Custom date range filtering
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                const min = picker.startDate.toDate();
                const max = picker.endDate.toDate();
                const dateStr = data[5]; // Date column
                const date = moment(dateStr, 'MMM DD, YYYY').toDate();
                
                if (
                    (min === null && max === null) ||
                    (min === null && date <= max) ||
                    (min <= date && max === null) ||
                    (min <= date && date <= max)
                ) {
                    return true;
                }
                return false;
            }
        );
        
        table.draw();
        updateEntriesInfo();
    });
    
    $('#dateRangeFilter').on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
        $.fn.dataTable.ext.search.pop();
        table.draw();
        updateEntriesInfo();
    });
    
    // Reset filters
    $('#resetFilters').click(function() {
        $('#userSearch').val('');
        $('#roleFilter').val('');
        $('#statusFilter').val('');
        $('#dateRangeFilter').val('');
        
        $.fn.dataTable.ext.search.pop();
        table.search('').columns().search('').draw();
        updateEntriesInfo();
    });
    
    // Update entries info
    function updateEntriesInfo() {
        const info = table.page.info();
        $('#showing-entries').text((info.start + 1) + '-' + info.end);
        $('.total-entries').text(info.recordsDisplay);
    }
    
    // Select all users checkbox
    $('#selectAllUsers').change(function() {
        const isChecked = $(this).prop('checked');
        $('.user-select-checkbox').prop('checked', isChecked);
        updateSelectedCount();
    });
    
    // Individual checkboxes
    $('.user-select-checkbox').change(function() {
        updateSelectedCount();
        
        // Check if all are checked
        const allChecked = $('.user-select-checkbox:checked').length === $('.user-select-checkbox').length;
        $('#selectAllUsers').prop('checked', allChecked);
    });
    
    // Update selected count
    function updateSelectedCount() {
        const count = $('.user-select-checkbox:checked').length;
        $('.selected-count').text(count);
        
        if (count > 0) {
            $('.user-selection-toolbar').removeClass('d-none');
        } else {
            $('.user-selection-toolbar').addClass('d-none');
        }
    }
    
    // Delete user modal setup
    $('#deleteUserModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const userId = button.data('user-id');
        const username = button.data('username');
        
        $('.user-delete-name').text(username);
        $('#deleteUserForm').attr('action', '/admin/users/' + userId + '/delete');
    });
    
    // Password toggle
    $('#passwordToggle').click(function() {
        const passwordInput = document.getElementById('newPassword');
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        $(this).find('i').toggleClass('bi-eye bi-eye-slash');
    });
    
    // Password strength checker
    $('#newPassword').on('input', function() {
        const password = $(this).val();
        const progressBar = $('.password-strength .progress-bar');
        const feedback = $('.password-feedback');
        
        // Calculate strength
        let strength = 0;
        
        if (password.length >= 8) strength += 25;
        if (password.match(/[a-z]/)) strength += 25;
        if (password.match(/[A-Z]/)) strength += 25;
        if (password.match(/[0-9!@#$%^&*(),.?":{}|<>]/)) strength += 25;
        
        // Update UI
        progressBar.css('width', strength + '%');
        
        if (strength <= 25) {
            progressBar.removeClass().addClass('progress-bar bg-danger');
            feedback.text('Password strength: Too weak');
        } else if (strength <= 50) {
            progressBar.removeClass().addClass('progress-bar bg-warning');
            feedback.text('Password strength: Weak');
        } else if (strength <= 75) {
            progressBar.removeClass().addClass('progress-bar bg-info');
            feedback.text('Password strength: Good');
        } else {
            progressBar.removeClass().addClass('progress-bar bg-success');
            feedback.text('Password strength: Strong');
        }
    });
    
    // Export buttons
    $('#exportCsvBtn').click(function() {
        exportTable('csv');
    });
    
    $('#exportExcelBtn').click(function() {
        exportTable('excel');
    });
    
    $('#exportPdfBtn').click(function() {
        exportTable('pdf');
    });
    
    function exportTable(type) {
        const exportTable = $('#usersTable').DataTable({
            retrieve: true,
            buttons: [
                {
                    extend: type,
                    exportOptions: {
                        columns: [1, 2, 3, 4, 5]
                    }
                }
            ]
        });
        
        exportTable.button('.buttons-' + type).trigger();
    }
    
    // Initialize user charts - fixed version with proper error handling
    try {
        initUserCharts();
    } catch (error) {
        console.error("Error initializing charts:", error);
    }
    
    function initUserCharts() {
        // Check if ApexCharts is available
        if (typeof ApexCharts === 'undefined') {
            console.error('ApexCharts library not loaded');
            return;
        }
        
        // Registration trend chart
        const registrationOptions = {
            series: [{
                name: 'New Users',
                data: [12, 19, 3, 5, 2, 3, 8]
            }],
            chart: {
                height: 300,
                type: 'area',
                toolbar: {
                    show: false
                },
                zoom: {
                    enabled: false
                }
            },
            colors: ['#4361ee'],
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: 2
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.7,
                    opacityTo: 0.3,
                    stops: [0, 90, 100]
                }
            },
            xaxis: {
                categories: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
            },
            tooltip: {
                x: {
                    format: 'dd/MM/yy'
                }
            }
        };
        
        // Safely get user counts from server-rendered data
        const adminCount = parseInt('{{ users|selectattr("role", "equalto", "admin")|list|length|default(0) }}', 10); 
        const modCount = parseInt('{{ users|selectattr("role", "equalto", "mod")|list|length|default(0) }}', 10);
        const userCount = parseInt('{{ users|selectattr("role", "equalto", "user")|list|length|default(0) }}', 10);
        
        const userRolesOptions = {
            series: [adminCount, modCount, userCount],
            chart: {
                height: 300,
                type: 'donut'
            },
            labels: ['Admins', 'Moderators', 'Users'],
            colors: ['#ef476f', '#16c79a', '#4361ee'],
            plotOptions: {
                pie: {
                    donut: {
                        size: '65%',
                        background: 'transparent',
                        labels: {
                            show: true,
                            name: {
                                show: true
                            },
                            value: {
                                show: true,
                                formatter: function(val) {
                                    return val;
                                }
                            },
                            total: {
                                show: true,
                                label: 'Total Users',
                                formatter: function(w) {
                                    return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                }
                            }
                        }
                    }
                }
            },
            dataLabels: {
                enabled: false
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    chart: {
                        height: 250
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }],
            legend: {
                position: 'bottom',
                offsetY: 0
            }
        };
        
        try {
            const registrationChart = new ApexCharts(document.querySelector("#userRegistrationChart"), registrationOptions);
            registrationChart.render();
            
            const userRolesChart = new ApexCharts(document.querySelector("#userRolesChart"), userRolesOptions);
            userRolesChart.render();
        } catch (error) {
            console.error("Error rendering charts:", error);
        }
    }
    
    // Edit user functionality - fixed to handle missing elements
    document.querySelectorAll('.edit-user-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const userId = this.getAttribute('data-user-id');
            const row = document.querySelector(`tr[data-user-id="${userId}"]`);
            
            if (row) {
                // Get user data from the row
                const username = row.querySelector('.user-name-link').textContent.trim();
                const email = row.querySelector('td:nth-child(3)').textContent.trim();
                
                // Fix role detection - extract properly from badge text
                const badgeElement = row.querySelector('.badge');
                const role = badgeElement ? badgeElement.textContent.trim().toLowerCase() : 'user';
                
                const isVerified = row.querySelector('.status-indicator-dot').classList.contains('success');
                
                // Populate modal - check if elements exist before setting values
                const usernameField = document.getElementById('editUsername');
                const emailField = document.getElementById('editEmail');
                const roleField = document.getElementById('editRole');
                const verifiedCheckbox = document.getElementById('editIsVerified');
                
                if (usernameField) usernameField.value = username;
                if (emailField) emailField.value = email;
                if (roleField) {
                    // Make sure the value matches one of the available options
                    roleField.value = ['admin', 'mod', 'user'].includes(role) ? role : 'user';
                }
                if (verifiedCheckbox) verifiedCheckbox.checked = isVerified;
                
                // Set form action
                const form = document.getElementById('editUserForm');
                if (form) form.action = `/admin/users/${userId}/update`;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            }
        });
    });
    
    // Fix selection toolbar buttons with error handling
    const verifySelectedBtn = document.querySelector('.user-selection-toolbar .admin-btn-outline-primary');
    if (verifySelectedBtn) {
        verifySelectedBtn.addEventListener('click', function() {
            const selectedUsers = Array.from(document.querySelectorAll('.user-select-checkbox:checked')).map(checkbox => {
                return checkbox.closest('tr').getAttribute('data-user-id');
            });
            
            if (selectedUsers.length === 0) return;
            
            // Show confirmation
            Swal.fire({
                title: 'Verify Selected Users',
                text: `Are you sure you want to verify ${selectedUsers.length} selected users?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, verify them',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading
                    document.getElementById('loadingOverlay').style.display = 'flex';
                    
                    // Create form data with selected user IDs
                    const formData = new FormData();
                    formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
                    selectedUsers.forEach((userId, index) => {
                        formData.append(`user_ids[${index}]`, userId);
                    });
                    
                    // Send request to verify users
                    fetch('/admin/users/verify-multiple', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        if (data.success) {
                            Swal.fire({
                                title: 'Users Verified',
                                text: `${selectedUsers.length} users have been verified successfully`,
                                icon: 'success'
                            }).then(() => {
                                // Reload the page to show changes
                                window.location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message || 'An error occurred while verifying users',
                                icon: 'error'
                            });
                        }
                    })
                    .catch(error => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while verifying users',
                            icon: 'error'
                        });
                    });
                }
            });
        });
    }
    
    const lockSelectedBtn = document.querySelector('.user-selection-toolbar .admin-btn-outline-warning');
    if (lockSelectedBtn) {
        lockSelectedBtn.addEventListener('click', function() {
            const selectedUsers = Array.from(document.querySelectorAll('.user-select-checkbox:checked')).map(checkbox => {
                return checkbox.closest('tr').getAttribute('data-user-id');
            });
            
            if (selectedUsers.length === 0) return;
            
            // Show confirmation
            Swal.fire({
                title: 'Lock Selected Users',
                text: `Are you sure you want to lock ${selectedUsers.length} selected users? They will not be able to log in until unlocked.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, lock them',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading
                    document.getElementById('loadingOverlay').style.display = 'flex';
                    
                    // Create form data with selected user IDs
                    const formData = new FormData();
                    formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
                    selectedUsers.forEach((userId, index) => {
                        formData.append(`user_ids[${index}]`, userId);
                    });
                    
                    // Send request to lock users
                    fetch('/admin/users/lock-multiple', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        if (data.success) {
                            Swal.fire({
                                title: 'Users Locked',
                                text: `${selectedUsers.length} users have been locked successfully`,
                                icon: 'success'
                            }).then(() => {
                                // Reload the page to show changes
                                window.location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message || 'An error occurred while locking users',
                                icon: 'error'
                            });
                        }
                    })
                    .catch(error => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while locking users',
                            icon: 'error'
                        });
                    });
                }
            });
        });
    }
    
    const deleteSelectedBtn = document.querySelector('.user-selection-toolbar .admin-btn-outline-danger');
    if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', function() {
            const selectedUsers = Array.from(document.querySelectorAll('.user-select-checkbox:checked')).map(checkbox => {
                return checkbox.closest('tr').getAttribute('data-user-id');
            });
            
            if (selectedUsers.length === 0) return;
            
            // Show confirmation
            Swal.fire({
                title: 'Delete Selected Users',
                text: `Are you sure you want to delete ${selectedUsers.length} selected users? This action cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'Yes, delete them',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading
                    document.getElementById('loadingOverlay').style.display = 'flex';
                    
                    // Create form data with selected user IDs
                    const formData = new FormData();
                    formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
                    selectedUsers.forEach((userId, index) => {
                        formData.append(`user_ids[${index}]`, userId);
                    });
                    
                    // Send request to delete users
                    fetch('/admin/users/delete-multiple', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        if (data.success) {
                            Swal.fire({
                                title: 'Users Deleted',
                                text: `${selectedUsers.length} users have been deleted successfully`,
                                icon: 'success'
                            }).then(() => {
                                // Reload the page to show changes
                                window.location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message || 'An error occurred while deleting users',
                                icon: 'error'
                            });
                        }
                    })
                    .catch(error => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while deleting users',
                            icon: 'error'
                        });
                    });
                }
            });
        });
    }
    
    // Fix cancel button in selection toolbar with error handling
    const cancelSelectionBtn = document.querySelector('.user-selection-toolbar .admin-btn-outline-secondary');
    if (cancelSelectionBtn) {
        cancelSelectionBtn.addEventListener('click', function() {
            document.querySelectorAll('.user-select-checkbox, #selectAllUsers').forEach(checkbox => {
                checkbox.checked = false;
            });
            $('.user-selection-toolbar').addClass('d-none');
        });
    }
});
</script>

<style>
.admin-stats-widget {
    background-color: var(--admin-white);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(var(--widget-color-rgb), 0.1);
    height: 100%;
    display: flex;
    transition: var(--admin-transition);
    border: 1px solid rgba(0, 0, 0, 0.03);
}

.admin-stats-widget:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(var(--widget-color-rgb), 0.15);
    border-color: rgba(var(--widget-color-rgb), 0.1);
}

.stats-widget-icon {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    border-radius: 12px;
    background-color: rgba(var(--widget-color-rgb), 0.1);
    color: var(--widget-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-right: 20px;
}

.stats-widget-content {
    flex-grow: 1;
}

.stats-widget-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.2rem;
    color: var(--admin-dark);
}

.stats-widget-label {
    color: var(--admin-muted);
    margin-bottom: 0;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Admin spinner for loading overlay */
.admin-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(67, 97, 238, 0.3);
    border-radius: 50%;
    border-top-color: var(--admin-primary);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Table styling enhancements */
.user-data-table {
    position: relative;
    overflow: auto;
    width: 100%;
}

/* Custom avatar styling */
.avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1rem;
    flex-shrink: 0;
}

.avatar-admin {
    background: linear-gradient(135deg, #ef476f, #b5179e);
}

.avatar-mod {
    background: linear-gradient(135deg, #4cc9f0, #4361ee);
}

.avatar-user {
    background: linear-gradient(135deg, #06d6a0, #118ab2);
}

.user-name-link {
    color: var(--admin-dark);
    text-decoration: none;
    font-weight: 600;
    transition: var(--admin-transition);
}

.user-name-link:hover {
    color: var(--admin-primary);
}

.status-indicator-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 5px;
}

.status-indicator-dot.success {
    background-color: var(--admin-success);
    box-shadow: 0 0 0 2px rgba(22, 199, 154, 0.2);
}

.status-indicator-dot.danger {
    background-color: var(--admin-danger);
    box-shadow: 0 0 0 2px rgba(239, 71, 111, 0.2);
}

/* Animation for rows */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.5s ease forwards;
}

.delay-1 { animation-delay: 0.05s; }
.delay-2 { animation-delay: 0.1s; }
.delay-3 { animation-delay: 0.15s; }
.delay-4 { animation-delay: 0.2s; }
.delay-5 { animation-delay: 0.25s; }
/* Continue with more delays as needed */

@media (max-width: 768px) {
    .admin-stats-widget {
        flex-direction: column;
        text-align: center;
    }
    
    .stats-widget-icon {
        margin: 0 auto 15px;
    }
    
    .user-filters .form-select,
    .user-filters .input-group,
    .user-filters .admin-btn {
        margin-bottom: 10px;
    }
}
</style>
{% endblock %}